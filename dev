#!/usr/bin/env python3
"""
Development CLI - telegram-bot-stack

Quick access to all development commands.
"""

import argparse
import subprocess
import sys


class Colors:
    """Terminal colors."""

    BLUE = "\033[0;34m"
    GREEN = "\033[0;32m"
    YELLOW = "\033[0;33m"
    RED = "\033[0;31m"
    BOLD = "\033[1m"
    NC = "\033[0m"  # No Color


def run_command(cmd, check=True):
    """Run shell command."""
    print(f"{Colors.BLUE}→ {' '.join(cmd)}{Colors.NC}")
    result = subprocess.run(cmd, check=False)
    if check and result.returncode != 0:
        print(f"{Colors.RED}✗ Command failed with code {result.returncode}{Colors.NC}")
        sys.exit(result.returncode)
    return result.returncode


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(
        description="telegram-bot-stack development CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  ./dev status              # Show project status
  ./dev test               # Run all tests
  ./dev test fast          # Run fast tests
  ./dev lint               # Run linter
  ./dev pr check 5         # Check PR #5 CI status
  ./dev pr create          # Create PR
  ./dev ci check           # Check CI for current branch

For more commands: ./dev help
        """,
    )

    subparsers = parser.add_subparsers(dest="command", help="Command to run")

    # Status
    subparsers.add_parser("status", help="Show project status")

    # Test commands
    test_parser = subparsers.add_parser("test", help="Run tests")
    test_parser.add_argument(
        "mode",
        nargs="?",
        choices=["fast", "cov", "unit", "integration", "watch"],
        help="Test mode",
    )

    # Lint/Format commands
    lint_parser = subparsers.add_parser("lint", help="Run linter")
    lint_parser.add_argument("--fix", action="store_true", help="Auto-fix issues")

    format_parser = subparsers.add_parser("format", help="Format code")
    format_parser.add_argument("--check", action="store_true", help="Check only")

    # Type check
    subparsers.add_parser("typecheck", help="Run type checker")

    # CI commands
    ci_parser = subparsers.add_parser("ci", help="CI commands")
    ci_subparsers = ci_parser.add_subparsers(dest="ci_command")

    ci_subparsers.add_parser("run", help="Run all CI checks locally")
    ci_check_parser = ci_subparsers.add_parser("check", help="Check CI status")
    ci_check_parser.add_argument("ref", nargs="?", help="Branch or commit to check")

    # PR commands
    pr_parser = subparsers.add_parser("pr", help="Pull Request commands")
    pr_subparsers = pr_parser.add_subparsers(dest="pr_command")

    pr_check = pr_subparsers.add_parser("check", help="Check PR CI status")
    pr_check.add_argument("pr_number", type=int, help="PR number")

    pr_create = pr_subparsers.add_parser("create", help="Create Pull Request")
    pr_create.add_argument("--title", required=True, help="PR title")
    pr_create.add_argument("--closes", type=int, help="Issue to close")
    pr_create.add_argument("--draft", action="store_true", help="Create as draft")

    pr_subparsers.add_parser("list", help="List recent PRs")

    # Merge commands
    merge_parser = subparsers.add_parser("merge", help="PR merge operations")
    merge_subparsers = merge_parser.add_subparsers(dest="merge_command")

    merge_analyze = merge_subparsers.add_parser(
        "analyze", help="Analyze PR (release vs non-release)"
    )
    merge_analyze.add_argument("pr_number", type=int, help="PR number")

    merge_now = merge_subparsers.add_parser("now", help="Merge PR with squash")
    merge_now.add_argument("pr_number", type=int, help="PR number")
    merge_now.add_argument(
        "--dry-run", action="store_true", help="Dry run (don't merge)"
    )

    # Issue commands
    issue_parser = subparsers.add_parser("issue", help="Issue commands")
    issue_subparsers = issue_parser.add_subparsers(dest="issue_command")

    issue_subparsers.add_parser("list", help="List open issues")

    issue_read = issue_subparsers.add_parser("read", help="Read specific issue")
    issue_read.add_argument("issue_number", type=int, help="Issue number")

    # Clean
    clean_parser = subparsers.add_parser("clean", help="Clean build artifacts")
    clean_parser.add_argument("--all", action="store_true", help="Clean everything")

    # Setup
    subparsers.add_parser("setup", help="Setup development environment")

    # Help
    subparsers.add_parser("help", help="Show detailed help")

    args = parser.parse_args()

    # Handle commands
    if not args.command or args.command == "help":
        parser.print_help()
        print(f"\n{Colors.GREEN}Quick commands:{Colors.NC}")
        print(f"  {Colors.YELLOW}./dev status{Colors.NC}        - Project status")
        print(f"  {Colors.YELLOW}./dev test{Colors.NC}          - Run tests")
        print(f"  {Colors.YELLOW}./dev lint{Colors.NC}          - Check code")
        print(f"  {Colors.YELLOW}./dev pr check 5{Colors.NC}    - Check PR #5")
        print(f"\n{Colors.BLUE}Or use make directly:{Colors.NC} make help")
        return

    if args.command == "status":
        run_command(["make", "status"])

    elif args.command == "test":
        if args.mode == "fast":
            run_command(["make", "test-fast"])
        elif args.mode == "cov":
            run_command(["make", "test-cov"])
        elif args.mode == "unit":
            run_command(["make", "test-unit"])
        elif args.mode == "integration":
            run_command(["make", "test-integration"])
        elif args.mode == "watch":
            run_command(["make", "test-watch"])
        else:
            run_command(["make", "test"])

    elif args.command == "lint":
        if args.fix:
            run_command(["make", "lint-fix"])
        else:
            run_command(["make", "lint"])

    elif args.command == "format":
        if args.check:
            run_command(["make", "format-check"])
        else:
            run_command(["make", "format"])

    elif args.command == "typecheck":
        run_command(["make", "type-check"])

    elif args.command == "ci":
        if args.ci_command == "run":
            run_command(["make", "ci"])
        elif args.ci_command == "check":
            if args.ref:
                run_command(
                    [
                        "python3",
                        ".github/workflows/scripts/check_ci.py",
                        "--branch",
                        args.ref,
                    ]
                )
            else:
                run_command(["make", "ci-check"])

    elif args.command == "pr":
        if args.pr_command == "check":
            run_command(
                [
                    "python3",
                    ".github/workflows/scripts/check_ci.py",
                    "--pr",
                    str(args.pr_number),
                ]
            )
        elif args.pr_command == "create":
            cmd = [
                "python3",
                ".github/workflows/scripts/create_pr.py",
                "--title",
                args.title,
            ]
            if args.closes:
                cmd.extend(["--closes", str(args.closes)])
            if args.draft:
                cmd.append("--draft")
            run_command(cmd)
        elif args.pr_command == "list":
            run_command(
                ["python3", ".github/workflows/scripts/check_ci.py", "--list-prs"]
            )

    elif args.command == "merge":
        if args.merge_command == "analyze":
            run_command(
                [
                    "python3",
                    ".github/workflows/scripts/analyze_pr.py",
                    "--pr",
                    str(args.pr_number),
                ]
            )
        elif args.merge_command == "now":
            cmd = [
                "python3",
                ".github/workflows/scripts/merge_pr.py",
                "--pr",
                str(args.pr_number),
            ]
            if args.dry_run:
                cmd.append("--dry-run")
            run_command(cmd)

    elif args.command == "issue":
        if args.issue_command == "list":
            run_command(["make", "issue-list"])
        elif args.issue_command == "read":
            run_command(
                [
                    "python3",
                    ".github/workflows/scripts/read_issues.py",
                    str(args.issue_number),
                ]
            )

    elif args.command == "clean":
        if args.all:
            run_command(["make", "clean-all"])
        else:
            run_command(["make", "clean"])

    elif args.command == "setup":
        run_command(["make", "setup"])


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Colors.YELLOW}✗ Interrupted{Colors.NC}")
        sys.exit(130)
