name: Type Check

# Static type checking with mypy
# Run locally: mypy telegram_bot_stack --exclude="telegram_bot_stack/cli/templates"

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/PROJECT_STATUS.md"
  workflow_call: # Allow being called by release.yml
  workflow_dispatch: # Allow manual trigger

jobs:
  mypy:
    name: mypy
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-cache-${{ hashFiles('telegram_bot_stack/**/*.py') }}
          restore-keys: |
            mypy-cache-

      - name: Install dependencies
        run: |
          echo "::group::ðŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          echo "::endgroup::"

      - name: Run mypy
        id: mypy_check
        # Note: continue-on-error allows the job to show warnings without failing CI
        # TODO: Fix type errors and remove this flag
        continue-on-error: true
        run: |
          echo "::group::ðŸ” Running mypy type checker"
          mypy telegram_bot_stack --exclude="telegram_bot_stack/cli/templates" 2>&1 | tee mypy_output.log
          MYPY_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $MYPY_EXIT_CODE

      - name: Analyze type errors
        if: always()
        run: |
          if [ "${{ steps.mypy_check.outcome }}" == "success" ]; then
            echo "### âœ… Type Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**mypy:** No type errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Type Check Issues (Non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count errors
            ERROR_COUNT=$(grep -c "error:" mypy_output.log || echo "0")

            echo "**Type errors found:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show summary by error type
            echo "#### Common Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -30 mypy_output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Type checking is currently non-blocking. These are warnings only." >> $GITHUB_STEP_SUMMARY
          fi
