name: Unit Tests

# Fast unit tests (no Docker, no external services)
# Run locally: pytest --ignore=tests/integration --ignore=tests/e2e

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/PROJECT_STATUS.md"
      - "LICENSE"
      - ".gitignore"
      - ".cursorrules"
  workflow_call: # Allow being called by release.yml
  workflow_dispatch: # Allow manual trigger

jobs:
  unit-tests:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Configure Git
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub CI"

      - name: Cache pytest
        uses: actions/cache@v4
        with:
          path: .pytest_cache
          key: pytest-cache-${{ matrix.python-version }}-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-cache-${{ matrix.python-version }}-
            pytest-cache-

      - name: Install dependencies
        id: install_deps
        continue-on-error: true
        run: |
          echo "::group::ðŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev,database]"
          echo "::endgroup::"

          echo "::group::ðŸ“‹ Installed packages"
          pip list
          echo "::endgroup::"

      - name: Check dependency installation
        if: steps.install_deps.outcome != 'success'
        run: |
          echo "::error::âŒ Dependency installation failed!"
          echo "### âŒ Dependency Installation Failed (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Error:** Failed to install project dependencies." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Missing or incompatible dependencies in pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "- Python version incompatibility (current: ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues or PyPI unavailability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check the logs above for specific error messages.**" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Run unit tests with coverage
        id: pytest
        continue-on-error: true
        run: |
          echo "::group::ðŸ§ª Running unit tests (excluding integration and e2e)"
          pytest --cov=telegram_bot_stack \
                 --cov-report=xml \
                 --cov-report=term-missing \
                 --cov-report=html \
                 --ignore=tests/integration \
                 --ignore=tests/e2e \
                 -v \
                 --tb=short 2>&1 | tee pytest_output.log
          PYTEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $PYTEST_EXIT_CODE

      - name: Analyze test failures
        if: always() && steps.pytest.outcome != 'success'
        run: |
          # Extract failed tests
          FAILED_TESTS=$(grep "FAILED" pytest_output.log | head -20 || echo "No specific test failures found")

          # Extract syntax errors or import errors
          SYNTAX_ERRORS=$(grep -A 5 "SyntaxError\|ImportError\|ModuleNotFoundError" pytest_output.log | head -30 || echo "")

          # Extract type errors
          TYPE_ERRORS=$(grep -A 3 "TypeError\|AttributeError" pytest_output.log | head -20 || echo "")

          # Print to console with error annotation
          echo "::error::âŒ Tests failed on Python ${{ matrix.python-version }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” TEST FAILURE ANALYSIS - Python ${{ matrix.python-version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if [ -n "$SYNTAX_ERRORS" ]; then
            echo "ðŸš¨ SYNTAX/IMPORT ERRORS DETECTED:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$SYNTAX_ERRORS"
            echo ""
            echo "ðŸ’¡ LIKELY CAUSE: Python version incompatibility"
            echo "   Using Python 3.10+ syntax on Python 3.9"
            echo "   Common issues: dict[str, Any], list[int], X | Y union types"
            echo ""
            echo "ðŸ”§ FIX: Use typing module imports (Dict, List, Union, Optional)"
            echo ""
          fi

          if [ -n "$TYPE_ERRORS" ]; then
            echo "âš ï¸  TYPE ERRORS DETECTED:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$TYPE_ERRORS"
            echo ""
          fi

          echo "ðŸ“‹ FAILED TESTS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$FAILED_TESTS"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary for Summary tab
          echo "### âŒ Test Failures on Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$SYNTAX_ERRORS" ]; then
            echo "#### ðŸš¨ Syntax/Import Errors Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$SYNTAX_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Likely cause:** Python version incompatibility (e.g., using Python 3.10+ syntax on Python 3.9)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$TYPE_ERRORS" ]; then
            echo "#### âš ï¸ Type Errors Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TYPE_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "#### ðŸ“‹ Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**See full logs above for detailed error messages and tracebacks.**" >> $GITHUB_STEP_SUMMARY

      - name: Display test summary
        if: always() && steps.pytest.outcome == 'success'
        run: |
          echo "### âœ… Tests Passed on Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test count
          TEST_COUNT=$(grep -o "[0-9]* passed" pytest_output.log | head -1 || echo "All tests passed")
          echo "**Result:** $TEST_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Fail job if tests failed
        if: steps.pytest.outcome != 'success'
        run: |
          echo "::error::Tests failed on Python ${{ matrix.python-version }}"
          exit 1

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/

      - name: Check coverage threshold
        if: matrix.python-version == '3.12'
        id: coverage_check
        continue-on-error: true
        run: |
          echo "::group::ðŸ“Š Checking coverage"

          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          THRESHOLD=50

          echo "Coverage: $COVERAGE%"
          echo "Threshold: $THRESHOLD%"

          echo "::endgroup::"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below $THRESHOLD% threshold"

            echo "### âŒ Coverage Below Threshold" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            echo "**Required threshold:** $THRESHOLD%" >> $GITHUB_STEP_SUMMARY
            GAP=$(python -c "print(f'{$THRESHOLD - $COVERAGE:.2f}')")
            echo "**Gap:** ${GAP}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required:** Add more tests to increase coverage." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tip:** Check the coverage report artifact for uncovered lines." >> $GITHUB_STEP_SUMMARY

            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets $THRESHOLD% threshold"

            echo "### âœ… Coverage Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage:** $COVERAGE% (threshold: $THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          fi
