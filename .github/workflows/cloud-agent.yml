# ðŸ¤– Cloud Agent GitHub Actions Workflow
# Automates issue creation, task breakdown, and intelligent labeling

name: Cloud Agent - Issue Automation

on:
  # Trigger on issue comments for commands
  issue_comment:
    types: [created]

  # Trigger on new issues
  issues:
    types: [opened, labeled]

  # Manual trigger with custom inputs
  workflow_dispatch:
    inputs:
      command:
        description: "Command to execute"
        required: true
        type: choice
        options:
          - create_issue
          - breakdown_task
          - generate_acceptance_criteria
          - analyze_context

      issue_number:
        description: "Issue number (for breakdown/analysis)"
        required: false
        type: string

      description:
        description: "Issue description (for create_issue)"
        required: false
        type: string

# Permissions required for the workflow
permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  # Job 1: Process Commands
  process_command:
    name: Process Cloud Agent Command
    runs-on: ubuntu-latest

    # Only run if comment starts with /
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/'))

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[github-actions]"

      - name: Parse Command
        id: parse_command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python .github/workflows/scripts/parse_command.py

      - name: Execute Command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          COMMAND: ${{ steps.parse_command.outputs.command }}
          ARGS: ${{ steps.parse_command.outputs.args }}
        run: |
          python .github/workflows/scripts/execute_command.py

  # Job 2: Auto-Label New Issues
  auto_label:
    name: Auto-Label New Issue
    runs-on: ubuntu-latest

    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[github-actions]"

      - name: Analyze and Label Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python .github/workflows/scripts/auto_label.py

  # Job 3: Generate Subtasks
  generate_subtasks:
    name: Generate Subtasks for Complex Issues
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'epic')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[github-actions]"

      - name: Generate and Create Subtasks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python .github/workflows/scripts/generate_subtasks.py

  # Job 4: Add Acceptance Criteria
  add_acceptance_criteria:
    name: Add Acceptance Criteria
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      (contains(github.event.label.name, 'feature') ||
       contains(github.event.label.name, 'refactor'))

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[github-actions]"

      - name: Generate Acceptance Criteria
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python .github/workflows/scripts/add_acceptance_criteria.py

  # Job 5: Context Analysis
  analyze_context:
    name: Analyze Repository Context
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/analyze')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 100 # Fetch more history for analysis

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[github-actions]"

      - name: Analyze Codebase Context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python .github/workflows/scripts/analyze_context.py
