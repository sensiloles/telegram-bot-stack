name: Tests

# Unit tests (fast, no Docker required)
# Integration tests run separately in integration-tests.yml
# Run locally: make test-unit

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/PROJECT_STATUS.md"
      - "LICENSE"
      - ".gitignore"
      - ".cursorrules"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/PROJECT_STATUS.md"
      - "LICENSE"
      - ".gitignore"
      - ".cursorrules"
  workflow_call: # Allow this workflow to be called by other workflows

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Configure Git
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub CI"

      - name: Install dependencies
        id: install_deps
        continue-on-error: true
        run: |
          echo "::group::ğŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev,database]"
          echo "::endgroup::"

          echo "::group::ğŸ“‹ Installed packages"
          pip list
          echo "::endgroup::"

      - name: Check dependency installation
        if: steps.install_deps.outcome != 'success'
        run: |
          echo "::error::âŒ Dependency installation failed!"
          echo "### âŒ Dependency Installation Failed (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Error:** Failed to install project dependencies." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Missing or incompatible dependencies in pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "- Python version incompatibility (current: ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues or PyPI unavailability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check the logs above for specific error messages.**" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Run tests with coverage
        id: pytest
        continue-on-error: true
        run: |
          echo "::group::ğŸ§ª Running unit tests (excluding integration tests)"
          pytest --cov=telegram_bot_stack \
                 --cov-report=xml \
                 --cov-report=term-missing \
                 --cov-report=html \
                 --ignore=tests/integration \
                 -v \
                 --tb=short 2>&1 | tee pytest_output.log
          PYTEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $PYTEST_EXIT_CODE

      - name: Analyze test failures
        if: always() && steps.pytest.outcome != 'success'
        run: |
          # Extract failed tests
          FAILED_TESTS=$(grep "FAILED" pytest_output.log | head -20 || echo "No specific test failures found")

          # Extract syntax errors or import errors
          SYNTAX_ERRORS=$(grep -A 5 "SyntaxError\|ImportError\|ModuleNotFoundError" pytest_output.log | head -30 || echo "")

          # Extract type errors
          TYPE_ERRORS=$(grep -A 3 "TypeError\|AttributeError" pytest_output.log | head -20 || echo "")

          # Print to console with error annotation
          echo "::error::âŒ Tests failed on Python ${{ matrix.python-version }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” TEST FAILURE ANALYSIS - Python ${{ matrix.python-version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if [ -n "$SYNTAX_ERRORS" ]; then
            echo "ğŸš¨ SYNTAX/IMPORT ERRORS DETECTED:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$SYNTAX_ERRORS"
            echo ""
            echo "ğŸ’¡ LIKELY CAUSE: Python version incompatibility"
            echo "   Using Python 3.10+ syntax on Python 3.9"
            echo "   Common issues: dict[str, Any], list[int], X | Y union types"
            echo ""
            echo "ğŸ”§ FIX: Use typing module imports (Dict, List, Union, Optional)"
            echo ""
          fi

          if [ -n "$TYPE_ERRORS" ]; then
            echo "âš ï¸  TYPE ERRORS DETECTED:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$TYPE_ERRORS"
            echo ""
          fi

          echo "ğŸ“‹ FAILED TESTS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$FAILED_TESTS"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary for Summary tab
          echo "### âŒ Test Failures on Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$SYNTAX_ERRORS" ]; then
            echo "#### ğŸš¨ Syntax/Import Errors Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$SYNTAX_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Likely cause:** Python version incompatibility (e.g., using Python 3.10+ syntax on Python 3.9)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$TYPE_ERRORS" ]; then
            echo "#### âš ï¸ Type Errors Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TYPE_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "#### ğŸ“‹ Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**See full logs above for detailed error messages and tracebacks.**" >> $GITHUB_STEP_SUMMARY

      - name: Display test summary
        if: always() && steps.pytest.outcome == 'success'
        run: |
          echo "### âœ… Tests Passed on Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test count
          TEST_COUNT=$(grep -o "[0-9]* passed" pytest_output.log | head -1 || echo "All tests passed")
          echo "**Result:** $TEST_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Fail job if tests failed
        if: steps.pytest.outcome != 'success'
        run: |
          echo "::error::Tests failed on Python ${{ matrix.python-version }}"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                                â•‘"
          echo "â•‘  âŒ TESTS FAILED ON PYTHON ${{ matrix.python-version }}                                                â•‘"
          echo "â•‘                                                                                â•‘"
          echo "â•‘  Check the 'Analyze test failures' step above for:                            â•‘"
          echo "â•‘  â€¢ Syntax/Import errors (Python compatibility issues)                         â•‘"
          echo "â•‘  â€¢ Type errors                                                                 â•‘"
          echo "â•‘  â€¢ List of failed tests                                                        â•‘"
          echo "â•‘                                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          exit 1

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/

      - name: Check coverage threshold
        if: matrix.python-version == '3.12'
        id: coverage_check
        continue-on-error: true
        run: |
          echo "::group::ğŸ“Š Checking coverage"

          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          THRESHOLD=50

          echo "Coverage: $COVERAGE%"
          echo "Threshold: $THRESHOLD%"

          echo "::endgroup::"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below $THRESHOLD% threshold"

            echo "### âŒ Coverage Below Threshold" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            echo "**Required threshold:** $THRESHOLD%" >> $GITHUB_STEP_SUMMARY
            GAP=$(python -c "print(f'{$THRESHOLD - $COVERAGE:.2f}')")
            echo "**Gap:** ${GAP}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required:** Add more tests to increase coverage." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tip:** Check the coverage report artifact for uncovered lines." >> $GITHUB_STEP_SUMMARY

            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets $THRESHOLD% threshold"

            echo "### âœ… Coverage Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage:** $COVERAGE% (threshold: $THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Lint with Ruff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          echo "::group::ğŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          echo "::endgroup::"

      - name: Run Ruff linter
        id: ruff_lint
        continue-on-error: true
        run: |
          echo "::group::ğŸ” Running Ruff linter"
          ruff check . --output-format=github 2>&1 | tee ruff_lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $LINT_EXIT_CODE

      - name: Analyze linting errors
        if: always() && steps.ruff_lint.outcome != 'success'
        run: |
          # Count errors by type
          ERROR_COUNT=$(grep -c "error:" ruff_lint.log || echo "0")
          WARNING_COUNT=$(grep -c "warning:" ruff_lint.log || echo "0")

          # Print to console
          echo "::error::âŒ Linting errors detected"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¨ LINTING ERRORS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Errors: $ERROR_COUNT | Warnings: $WARNING_COUNT"
          echo ""
          echo "Top 20 issues:"
          head -20 ruff_lint.log
          echo ""
          echo "ğŸ”§ FIX: Run 'ruff check . --fix' locally to auto-fix issues"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary
          echo "### âŒ Linting Errors Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Warnings:** $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Top Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 ruff_lint.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix:** Run \`ruff check . --fix\` locally to auto-fix issues." >> $GITHUB_STEP_SUMMARY

      - name: Run Ruff formatter check
        id: ruff_format
        continue-on-error: true
        run: |
          echo "::group::ğŸ¨ Checking code formatting"
          ruff format --check . 2>&1 | tee ruff_format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $FORMAT_EXIT_CODE

      - name: Analyze formatting errors
        if: always() && steps.ruff_format.outcome != 'success'
        run: |
          # Extract files that need formatting
          UNFORMATTED_FILES=$(grep "Would reformat:" ruff_format.log || echo "")

          # Print to console
          echo "::error::âŒ Formatting issues detected"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¨ FORMATTING ISSUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -n "$UNFORMATTED_FILES" ]; then
            echo "$UNFORMATTED_FILES"
          fi
          echo ""
          echo "ğŸ”§ FIX: Run 'ruff format .' locally to format code"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary
          echo "### âŒ Formatting Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$UNFORMATTED_FILES" ]; then
            echo "#### Files needing formatting:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$UNFORMATTED_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix:** Run \`ruff format .\` locally to format code." >> $GITHUB_STEP_SUMMARY

      - name: Fail if linting or formatting failed
        if: steps.ruff_lint.outcome != 'success' || steps.ruff_format.outcome != 'success'
        run: |
          echo "::error::Linting or formatting checks failed"
          exit 1

  type-check:
    name: Type Check with mypy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          echo "::group::ğŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          echo "::endgroup::"

      - name: Run mypy
        id: mypy_check
        # Note: continue-on-error allows the job to show warnings without failing CI
        # TODO: Fix type errors and remove this flag
        continue-on-error: true
        run: |
          echo "::group::ğŸ” Running mypy type checker"
          mypy telegram_bot_stack --exclude="telegram_bot_stack/cli/templates" 2>&1 | tee mypy_output.log
          MYPY_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $MYPY_EXIT_CODE

      - name: Analyze type errors
        if: always() && steps.mypy_check.outcome != 'success'
        run: |
          echo "### âš ï¸ Type Check Issues (Non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count errors
          ERROR_COUNT=$(grep -c "error:" mypy_output.log || echo "0")

          echo "**Type errors found:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show summary by error type
          echo "#### Common Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -30 mypy_output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Type checking is currently non-blocking. These are warnings only." >> $GITHUB_STEP_SUMMARY

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, lint, type-check]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## ğŸ“Š Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize exit code
          EXIT_CODE=0

          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Check test results
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| ğŸ§ª **Tests** | âœ… Passed | All Python versions (3.9, 3.10, 3.11, 3.12) - 3.12 is primary |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ§ª **Tests** | âŒ Failed | Check individual jobs for details |" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

          # Check linting results
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| ğŸ¨ **Linting** | âœ… Passed | Ruff linter + formatter |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ¨ **Linting** | âŒ Failed | Check lint job for details |" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

          # Check type-check results (warning only, doesn't fail the build)
          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "| ğŸ” **Type Check** | âœ… Passed | mypy type checking |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ” **Type Check** | âš ï¸ Warning | Type issues detected (non-blocking) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Add helpful note
          if [ $EXIT_CODE -eq 0 ]; then
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** To see detailed test results with individual test names, click on the specific test jobs above (e.g., 'Test Python 3.12')." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above for detailed error messages." >> $GITHUB_STEP_SUMMARY
          fi

          # Exit with appropriate code
          exit $EXIT_CODE
