name: Lint

# Code quality checks with Ruff (linter + formatter)
# Run locally: ruff check . && ruff format --check .

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/PROJECT_STATUS.md"
  workflow_call: # Allow being called by release.yml
  workflow_dispatch: # Allow manual trigger

jobs:
  ruff:
    name: Ruff
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements*.txt

      - name: Cache Ruff
        uses: actions/cache@v4
        with:
          path: ~/.cache/ruff
          key: ruff-cache-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ruff-cache-

      - name: Install dependencies
        run: |
          echo "::group::ðŸ“¦ Installing dependencies"
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          echo "::endgroup::"

      - name: Run Ruff linter
        id: ruff_lint
        continue-on-error: true
        run: |
          echo "::group::ðŸ” Running Ruff linter"
          ruff check . --output-format=github 2>&1 | tee ruff_lint.log
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $LINT_EXIT_CODE

      - name: Analyze linting errors
        if: always() && steps.ruff_lint.outcome != 'success'
        run: |
          # Count errors by type
          ERROR_COUNT=$(grep -c "error:" ruff_lint.log || echo "0")
          WARNING_COUNT=$(grep -c "warning:" ruff_lint.log || echo "0")

          # Print to console
          echo "::error::âŒ Linting errors detected"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¨ LINTING ERRORS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Errors: $ERROR_COUNT | Warnings: $WARNING_COUNT"
          echo ""
          echo "Top 20 issues:"
          head -20 ruff_lint.log
          echo ""
          echo "ðŸ”§ FIX: Run 'ruff check . --fix' locally to auto-fix issues"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary
          echo "### âŒ Linting Errors Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Warnings:** $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Top Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 ruff_lint.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix:** Run \`ruff check . --fix\` locally to auto-fix issues." >> $GITHUB_STEP_SUMMARY

      - name: Run Ruff formatter check
        id: ruff_format
        continue-on-error: true
        run: |
          echo "::group::ðŸŽ¨ Checking code formatting"
          ruff format --check . 2>&1 | tee ruff_format.log
          FORMAT_EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          exit $FORMAT_EXIT_CODE

      - name: Analyze formatting errors
        if: always() && steps.ruff_format.outcome != 'success'
        run: |
          # Extract files that need formatting
          UNFORMATTED_FILES=$(grep "Would reformat:" ruff_format.log || echo "")

          # Print to console
          echo "::error::âŒ Formatting issues detected"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¨ FORMATTING ISSUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -n "$UNFORMATTED_FILES" ]; then
            echo "$UNFORMATTED_FILES"
          fi
          echo ""
          echo "ðŸ”§ FIX: Run 'ruff format .' locally to format code"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Also write to summary
          echo "### âŒ Formatting Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$UNFORMATTED_FILES" ]; then
            echo "#### Files needing formatting:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$UNFORMATTED_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fix:** Run \`ruff format .\` locally to format code." >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.ruff_lint.outcome }}" == "success" ] && [ "${{ steps.ruff_format.outcome }}" == "success" ]; then
            echo "### âœ… Linting Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ruff linter:** No issues found" >> $GITHUB_STEP_SUMMARY
            echo "**Ruff formatter:** Code is properly formatted" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if linting or formatting failed
        if: steps.ruff_lint.outcome != 'success' || steps.ruff_format.outcome != 'success'
        run: |
          echo "::error::Linting or formatting checks failed"
          exit 1
