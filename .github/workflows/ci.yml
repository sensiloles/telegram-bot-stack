name: CI

# Main CI orchestrator - runs all checks in parallel
# This is the main status check for PRs

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Run all checks in parallel for maximum speed
  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/unit-tests.yml

  integration-tests:
    name: Integration Tests
    uses: ./.github/workflows/integration-tests.yml

  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml

  type-check:
    name: Type Check
    uses: ./.github/workflows/type-check.yml

  # E2E tests are optional (allowed to fail)
  e2e-tests:
    name: E2E Tests (Optional)
    uses: ./.github/workflows/e2e-tests.yml

  # Summary job - required for merge
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint, type-check]
    if: always()

    steps:
      - name: Check CI results
        run: |
          echo "## ðŸ“Š CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize exit code
          EXIT_CODE=0

          echo "| Check | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Unit tests
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "| ðŸ§ª **Unit Tests** | âœ… Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª **Unit Tests** | âŒ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

          # Integration tests
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "| âš¡ **Integration Tests** | âœ… Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš¡ **Integration Tests** | âŒ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

          # Linting
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| ðŸŽ¨ **Linting** | âœ… Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ¨ **Linting** | âŒ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          fi

          # Type checking (warning only)
          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "| ðŸ” **Type Check** | âœ… Passed | No (warning) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” **Type Check** | âš ï¸ Warning | No (warning) |" >> $GITHUB_STEP_SUMMARY
          fi

          # E2E tests (optional)
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "| ðŸŽ¯ **E2E Tests** | âœ… Passed | No (optional) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-tests.result }}" == "skipped" ]; then
            echo "| ðŸŽ¯ **E2E Tests** | â­ï¸ Skipped | No (optional) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ¯ **E2E Tests** | âš ï¸ Failed | No (optional) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ $EXIT_CODE -eq 0 ]; then
            echo "### âœ… All Required Checks Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ready to merge** ðŸš€" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some Required Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the failing checks before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tip:** Click on the failed jobs above for detailed error messages." >> $GITHUB_STEP_SUMMARY
          fi

          # Exit with appropriate code
          exit $EXIT_CODE
