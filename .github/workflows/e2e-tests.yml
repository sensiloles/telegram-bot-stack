name: E2E Tests

# Full end-to-end tests with Docker (slow, ~15-45 min)
# Run locally: pytest tests/e2e/ --run-e2e

on:
  pull_request:
    branches: [main, develop]
  workflow_call: # Allow being called by release.yml
  workflow_dispatch: # Allow manual trigger

jobs:
  e2e:
    name: E2E Tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    continue-on-error: true # Don't block PR merge if E2E tests fail

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"] # Only test on latest Python for E2E

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Mock VPS Docker image
        run: |
          echo "ðŸ³ Building Mock VPS image..."
          docker build \
            -t mock-vps:latest \
            -f tests/integration/fixtures/Dockerfile.mock-vps \
            tests/integration/fixtures/
          docker images | grep mock-vps

      - name: Run E2E deployment tests
        run: |
          echo "ðŸŽ¯ Running E2E deployment tests (with Mock VPS)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          pytest tests/e2e/deployment/ \
            -v \
            --tb=short \
            --log-cli-level=INFO \
            --no-cov \
            --run-e2e \
            --maxfail=5

          echo "âœ… E2E tests completed"

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” Docker Containers Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          docker ps -a || true
          echo ""

          # Show logs from all containers
          for container in $(docker ps -a --format "{{.Names}}" 2>/dev/null); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“‹ Logs from: $container"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker logs --tail 100 "$container" 2>&1 || true
            echo ""
          done

      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up Docker resources..."
          docker compose -f tests/integration/fixtures/docker-compose.mock-vps.yml down -v || true
          docker system prune -af || true
          echo "âœ… Cleanup complete"

      - name: Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… E2E Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Python ${{ matrix.python-version }}:** All E2E tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ E2E Tests Failed (Non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Python ${{ matrix.python-version }}:** Some E2E tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** E2E tests are allowed to fail without blocking the build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check logs above for details**" >> $GITHUB_STEP_SUMMARY
          fi
