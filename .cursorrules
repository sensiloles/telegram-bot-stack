# Cursor Agent Rules - telegram-bot-stack

## Tool Selection Order (CRITICAL - Always Follow)

When multiple tools can solve the same task, use this priority:

### 1. MCP Tools (Preferred)

**Use first if available:**

- `mcp_github-workflow_list_issues()` - List/filter issues
- `mcp_github-workflow_get_issue()` - Get issue details
- `mcp_github-workflow_create_issue()` - Create issues
- `mcp_github-workflow_update_issue()` - Update issues
- `mcp_github-workflow_create_pr()` - Create PRs
- `mcp_github-workflow_merge_pr()` - Merge PRs

**Why:** Direct integration, faster, no shell overhead

### 2. CLI Scripts (Fallback)

**Use if MCP unavailable:**

```bash
python3 .github/workflows/scripts/read_issues.py --list
python3 .github/workflows/scripts/create_pr.py --title "..."
python3 .github/workflows/scripts/merge_pr.py --cleanup
```

**Why:** Reliable fallback, rich features, automation

### 3. Manual Git/GitHub (Last Resort)

**Use only if both above fail:**

```bash
git commands
gh cli commands (if available)
```

**Rule:** Try MCP ‚Üí CLI ‚Üí Manual. Don't mix approaches unnecessarily.

---

### Post-Merge Cleanup (MANDATORY)

After `mcp_github-workflow_merge_pr()`, always perform local cleanup:

```bash
# 1. Switch to main and pull
git checkout main && git pull origin main

# 2. Delete local feature branch
git branch -D <feature-branch-name>

# 3. Prune stale remote refs
git remote prune origin
```

**Why:** MCP deletes remote branch but leaves local branch. This matches CLI script behavior.

---

## CRITICAL WORKFLOW (Always Follow This Order)

### 1. GitHub Flow - NEVER Push to Main

```bash
git branch --show-current # MUST NOT be 'main'
```

If on main ‚Üí create feature branch:

```bash
git checkout -b feature/<issue>-<name> # or fix/, docs/
```

main branch is **protected** - direct pushes will fail.

### 2. Implementation

Before coding:

- Check open issues: Use MCP `list_issues` (or `read_issues.py --list`)
- Understand task requirements
- Plan changes

During implementation:

- Implement changes
- Write tests (>=80% coverage for `telegram_bot_stack/`)
- Update documentation if needed

### 3. Commit & Push

```bash
git status
git add .
git commit -m "type(scope): description" # See Conventional Commits below
git push -u origin feature/<name>
```

### 4. Create PR

```bash
# MCP (preferred):
mcp_github-workflow_create_pr(title="type(scope): description", closes_issue=<N>)

# CLI (fallback):
python3 .github/workflows/scripts/create_pr.py --title "..." --closes <N>
```

### 5. Merge PR

```bash
# MCP (preferred):
mcp_github-workflow_merge_pr(pr_number=<N>, delete_branch=true)

# CLI (fallback):
python3 .github/workflows/scripts/merge_pr.py --cleanup
```

---

## Project Context

**Name:** telegram-bot-stack
**Type:** Reusable Telegram bot framework (PyPI package)
**Repository:** https://github.com/sensiloles/telegram-bot-stack
**Phase:** Phase 2 - PyPI Publication
**Coverage:** 131 tests, 80% coverage

**Key Files:**

- Status: `.github/PROJECT_STATUS.md`
- Automation: `.github/workflows/scripts/README.md`
- MCP Setup: `docs/mcp-github-setup.md`

---

## Essential Commands

### Conventional Commits (REQUIRED)

Format: `type(scope): description`

**Version impact:**

- `feat:` ‚Üí MINOR bump (0.1.0 ‚Üí 0.2.0)
- `fix:` ‚Üí PATCH bump (0.1.0 ‚Üí 0.1.1)
- `feat!` or `BREAKING CHANGE:` ‚Üí MAJOR bump (0.x ‚Üí 1.0.0)
- `docs:`, `chore:`, `test:`, `refactor:` ‚Üí No bump

**Examples:**

```
feat(storage): add Redis backend
fix(auth): resolve token validation
docs(readme): update quickstart
```

### Testing

```bash
python3 -m pytest
python3 -m pytest --cov=telegram_bot_stack --cov-report=term
```

Threshold: >=80% for `telegram_bot_stack/`

---

## Code Quality Rules

### Security

- NEVER commit tokens/passwords
- Use `.env` (in `.gitignore`)

### Code Style

- All comments/docstrings in English
- Type hints for all new code
- Follow ruff linting (see `pyproject.toml`)
- Remove unused imports immediately

### Documentation

- UPDATE existing docs, don't create new `.md` files
- Update docs BEFORE committing code
- Keep examples executable
- Test instructions work "out of the box"

### Testing

- > =80% coverage for `telegram_bot_stack/`
- Write tests for all new features
- Use fixtures from `tests/conftest.py`

---

## Agent Decision Tree

### On New Context:

1. Read `.github/PROJECT_STATUS.md` (current state)
2. Check open issues: Use MCP `list_issues`
3. Verify branch: `git branch --show-current` (NOT main)
4. Understand task requirements
5. Implement following workflow above

### On "Continue Work":

1. Check `PROJECT_STATUS.md`
2. List open issues: Use MCP `list_issues` ‚Üí identify active
3. Read issue details: Use MCP `get_issue <N>`
4. Check current branch
5. Implement ‚Üí test ‚Üí commit ‚Üí push ‚Üí PR

### Branch Strategy:

- On main? ‚Üí Create `feature/<issue>-<name>`
- On feature branch? ‚Üí Continue work
- Multiple features? ‚Üí Ask user about separate branches

### Commit Strategy:

- One commit per logical unit
- Batch related changes (docs + tests together)
- Use conventional commits format

---

## Quick Reference

**Documentation:**

- GitHub Automation: `.github/workflows/scripts/README.md`
- MCP Setup: `docs/mcp-github-setup.md`
- Architecture: `README.md`
- Testing Guide: `README.md`

**Configuration:**

- Conventional Commits: https://www.conventionalcommits.org/
- Pre-commit hooks: `.pre-commit-config.yaml`
- Pytest: `pyproject.toml` ‚Üí `[tool.pytest.ini_options]`
- Ruff: `pyproject.toml` ‚Üí `[tool.ruff]`

---

## Summary Checklist

Before EVERY implementation:

- [ ] Check branch (not main)
- [ ] Check open issues (MCP or CLI)
- [ ] Understand task requirements
- [ ] Check existing code structure

After implementation:

- [ ] Write/update tests (>=80% coverage)
- [ ] Update docs if needed
- [ ] Run linting: `ruff check .`
- [ ] Run tests: `pytest`
- [ ] Commit with conventional format
- [ ] Push + auto-create PR

On merge:

- [ ] Run `merge_pr` (MCP or CLI)
- [ ] Verify release triggered (if on main)
- [ ] Check CI passed

**Remember:** GitHub Flow ‚Üí Implementation ‚Üí Testing ‚Üí Docs ‚Üí Commit ‚Üí PR ‚Üí Merge

---

## Documentation Style Rules

### Emoji Usage

- Use emoji ONLY when necessary for visual navigation
- NO emoji in code comments, docstrings, or commit messages
- Acceptable: Section markers in user-facing docs (üìñ Documentation)

### Summary Documents

- NEVER create separate SUMMARY.md or \*\_SUMMARY.md files
- Always provide summaries directly in chat/response to user
- Exception: Project-level documentation (README.md, CHANGELOG.md)

**Rationale:** Summary files clutter repository, become outdated, duplicate information.

---

## Validation on Start

Before following any workflow, verify infrastructure:

**Check MCP:**
Try `mcp_github-workflow_list_issues()`:

- ‚úÖ Works ‚Üí Use MCP tools
- ‚ùå Fails ‚Üí Use CLI scripts fallback

**Check Automation:**

```bash
ls .github/workflows/scripts/
```

- ‚úÖ Exists ‚Üí Use automation scripts
- ‚ùå Missing ‚Üí Use manual git commands

**Rule:** Never assume infrastructure exists. Verify first, adapt workflow accordingly. If infrastructure missing, INFORM USER instead of silently failing.

---

**File Size:** Target <300 lines | Current: ~270 lines ‚úì
**Goal:** Maximum density, minimum tokens, zero ambiguity
