# Cursor Agent Rules - telegram-bot-stack

## CRITICAL WORKFLOW (Always Follow This Order)

### 1. GitHub Flow - NEVER Push to Main

```bash
git branch --show-current # MUST NOT be 'main'
```

If on main ‚Üí create feature branch:
```bash
git checkout -b feature/<issue>-<name> # or fix/, docs/
```

main branch is **protected** - direct pushes will fail.

### 2. Implementation

Before coding:
- Check open issues: Use MCP `list_issues` (or `python3 .github/workflows/scripts/read_issues.py --list --state open`)
- Understand task requirements
- Plan changes

During implementation:
- Implement changes
- Write tests (>=80% coverage for `telegram_bot_stack/`)
- Update documentation if needed

### 3. Commit & Push

```bash
git status
git add .
git commit -m "type(scope): description" # See Conventional Commits below
git push -u origin feature/<name>
```

### 4. Create PR (Automated)

```bash
python3 .github/workflows/scripts/create_pr.py --title "type(scope): description" --closes <issue>
```

### 5. Merge PR (One Command)

```bash
python3 .github/workflows/scripts/merge_pr.py --cleanup
```

---

## Project Context

**Name:** telegram-bot-stack
**Type:** Reusable Telegram bot framework (PyPI package)
**Repository:** https://github.com/sensiloles/telegram-bot-stack
**Phase:** Phase 2 - PyPI Publication
**Coverage:** 131 tests, 80% coverage

**Key Files:**
- Status: `.github/PROJECT_STATUS.md`
- Automation: `.github/workflows/scripts/` (automation scripts)
- MCP Server: `scripts/mcp_github_server.py` (GitHub issues integration)
- Plan: `archive/PACKAGE_CONVERSION_PLAN_RU.md` (archived)

---

## Essential Commands

### Conventional Commits (REQUIRED)

Format: `type(scope): description`

**Version impact:**
- `feat:` ‚Üí MINOR bump (0.1.0 ‚Üí 0.2.0)
- `fix:` ‚Üí PATCH bump (0.1.0 ‚Üí 0.1.1)
- `feat!` or `BREAKING CHANGE:` ‚Üí MAJOR bump (0.x ‚Üí 1.0.0)
- `docs:`, `chore:`, `test:`, `refactor:` ‚Üí No bump

**Examples:**
```
feat(storage): add Redis backend
fix(auth): resolve token validation
docs(readme): update quickstart
```

### GitHub Automation

**Preferred: MCP Server (if configured)**
Use MCP tools for GitHub issues directly in chat:
- `list_issues` - List issues with filters
- `get_issue` - Get issue details
- `create_issue` - Create new issue
- `update_issue` - Update labels, priority, comments, state

**Fallback: CLI Scripts**
```bash
python3 .github/workflows/scripts/read_issues.py --list --state open
python3 .github/workflows/scripts/create_issue.py --title "Bug: X" --labels bug
python3 .github/workflows/scripts/update_issue.py <N> --set-priority high
python3 .github/workflows/scripts/create_pr.py --title "feat: X" --closes <N>
python3 .github/workflows/scripts/merge_pr.py --cleanup
```

See: `.github/workflows/scripts/README.md` for all scripts.
MCP Setup: `docs/mcp-github-setup.md`

### Testing

```bash
python3 -m pytest
python3 -m pytest --cov=telegram_bot_stack --cov-report=term
```

Threshold: >=80% for `telegram_bot_stack/`

---

## Code Quality Rules

### Security
- NEVER commit tokens/passwords
- Use `.env` (in `.gitignore`)

### Code Style
- All comments/docstrings in English
- Type hints for all new code
- Follow ruff linting (see `pyproject.toml`)
- Remove unused imports immediately

### Documentation
- UPDATE existing docs, don't create new `.md` files
- Update docs BEFORE committing code
- Keep examples executable
- Test instructions work "out of the box"

### Testing
- >=80% coverage for `telegram_bot_stack/`
- Write tests for all new features
- Use fixtures from `tests/conftest.py`

---

## Agent Decision Tree

### On New Context:
1. Read `.github/PROJECT_STATUS.md` (current state)
2. Check open issues: Use MCP `list_issues` tool (or `read_issues.py --list --state open`)
3. Verify branch: `git branch --show-current` (NOT main)
4. Understand task requirements
5. Implement following workflow above

### On "Continue Work":
1. Check `PROJECT_STATUS.md`
2. List open issues: Use MCP `list_issues` ‚Üí identify active
3. Read issue details: Use MCP `get_issue <N>`
4. Check current branch
5. Implement ‚Üí test ‚Üí commit ‚Üí push ‚Üí PR

### Branch Strategy:
- On main? ‚Üí Create `feature/<issue>-<name>`
- On feature branch? ‚Üí Continue work
- Multiple features? ‚Üí Ask user about separate branches

### Commit Strategy:
- One commit per logical unit
- Batch related changes (docs + tests together)
- Use conventional commits format

---

## Reference Links

**Detailed guides:**
- GitHub Automation: `.github/workflows/scripts/README.md`
- MCP Setup: `docs/mcp-github-setup.md`
- PR Automation: `.github/PR_AUTOMATION.md`
- Architecture: `README.md` (lines 155-250)
- Testing: `README.md` (lines 80-154)

**Configuration:**
- Conventional Commits: https://www.conventionalcommits.org/
- Pre-commit hooks: `.pre-commit-config.yaml`
- Pytest config: `pyproject.toml` ‚Üí `[tool.pytest.ini_options]`
- Ruff config: `pyproject.toml` ‚Üí `[tool.ruff]`

**Project files:**
- Status: `.github/PROJECT_STATUS.md`
- Plan (archived): `archive/PACKAGE_CONVERSION_PLAN_RU.md`
- Changelog: `CHANGELOG.md`

---

## Quick Examples

### Example 1: Add new storage backend

```python
# 1. Check existing storage implementations
# Read: telegram_bot_stack/storage/base.py
# Read: telegram_bot_stack/storage/sql.py (as reference)

# 2. Implement: telegram_bot_stack/storage/redis.py

# 3. Write tests: tests/core/test_redis_storage.py

# 4. Update docs: docs/storage_guide.md

# 5. Commit
git add telegram_bot_stack/storage/redis.py tests/core/test_redis_storage.py docs/storage_guide.md
git commit -m "feat(storage): add Redis backend"
```

### Example 2: Update documentation

```python
# 1. Identify doc to update
# Edit: docs/api_reference.md

# 2. Test examples still work

# 3. Commit
git commit -m "docs(api): update storage backend examples"
```

### Example 3: Fix bug

```python
# 1. Create issue (if not exists)
python3 .github/workflows/scripts/create_issue.py \
--title "Bug: Connection leak in SQL storage" \
--labels bug

# 2. Create branch
git checkout -b fix/sql-connection-leak

# 3. Fix code + add test

# 4. Commit
git commit -m "fix(storage): resolve SQL connection leak"

# 5. Push and create PR
git push -u origin fix/sql-connection-leak
python3 .github/workflows/scripts/create_pr.py \
--title "fix(storage): resolve SQL connection leak" \
--closes <issue_number>
```

---

## Maintenance

### Check Before Writing Code:
```bash
ls .github/workflows/scripts/ # automation scripts exist
```

Use existing tools instead of ad-hoc PyGithub code.

### File Size Policy:
This file (.cursorrules) target: <300 lines
Current: ~290 lines ‚úì

When updating:
1. Add new critical rule
2. Remove compensating verbose content
3. Verify: `wc -l .cursorrules`
4. Reference external docs instead of duplicating

Goal: Maximum density, minimum tokens, zero ambiguity.

---

## Summary Checklist

Before EVERY implementation:
- [ ] Check branch (not main)
- [ ] Check open issues (MCP `list_issues` or CLI)
- [ ] Understand task requirements
- [ ] Check existing code structure

After implementation:
- [ ] Write/update tests (>=80% coverage)
- [ ] Update docs if needed
- [ ] Run linting: `ruff check .`
- [ ] Run tests: `pytest`
- [ ] Commit with conventional format
- [ ] Push + auto-create PR

On merge:
- [ ] Run `merge_pr.py --cleanup`
- [ ] Verify release triggered (if on main)
- [ ] Check CI passed

**Remember:** GitHub Flow ‚Üí Implementation ‚Üí Testing ‚Üí Docs ‚Üí Commit ‚Üí PR ‚Üí Merge

---

## Documentation Style Rules

### Emoji Usage
- Use emoji in documentation ONLY when necessary for visual navigation
- Maximum 1 emoji per section header in README files
- NO emoji in code comments, docstrings, or commit messages
- NO emoji in .cursorrules or technical configuration files
- Acceptable: Section markers in user-facing docs (üìñ Documentation, üöÄ Quick Start)
- Not acceptable: Decorative emoji, multiple emoji per line, emoji in explanations

**Rationale:** Emoji consume 3-4 bytes each, reduce readability in terminals, and add no semantic value to technical content.

### Summary Documents
- NEVER create separate SUMMARY.md or *_SUMMARY.md files
- Always provide summaries directly in chat/response to user
- Summaries should be comprehensive, structured, and include:
- What was done (with checkmarks)
- Testing results
- Impact assessment
- Next steps
- Exception: Project-level documentation (README.md, CHANGELOG.md) is acceptable

**Rationale:** Summary files clutter repository, become outdated, and duplicate information already in commits/PRs/chat history.

---

## Validation on Start

Before following any workflow, agent MUST verify infrastructure exists:

### 1. Check GitHub Automation
```bash
ls .github/workflows/scripts/
```
- ‚úÖ Exists ‚Üí Use GitHub automation scripts
- ‚ùå Missing ‚Üí Use manual git commands

### 2. Check MCP Server
Try MCP `list_issues` tool:
- ‚úÖ Works ‚Üí Use MCP tools
- ‚ùå Fails ‚Üí Use CLI scripts fallback

### 3. If Infrastructure Missing
- INFORM USER instead of silently failing
- Suggest running setup or using alternatives
- Continue with available tools

**Rule:** Never assume infrastructure exists. Verify first, adapt workflow accordingly.
