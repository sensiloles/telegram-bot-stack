[tox]
envlist = py39,py310,py311,py312
isolated_build = True
skip_missing_interpreters = True

[gh-actions]
python =
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312

[testenv]
description = Run tests with {basepython}
# Use modern PEP 517 installation instead of deprecated setup.py install
package = wheel
wheel_build_env = .pkg
deps =
    pytest>=8.1.1
    pytest-cov>=5.0.0
    pytest-asyncio>=0.23.6
    pytest-mock>=3.14.0
    pytest-xdist>=3.5.0
    testcontainers>=3.7.0
    sqlalchemy>=2.0,<3.0
    psycopg2-binary>=2.9
commands =
    # Skip E2E tests and don't fail on coverage threshold for multi-version testing
    pytest {posargs:--cov=telegram_bot_stack --cov-report=term --no-cov-on-fail}

[testenv:lint]
description = Run linters (ruff)
deps =
    ruff>=0.6.0
commands =
    ruff check .

[testenv:format]
description = Check code formatting
deps =
    ruff>=0.6.0
commands =
    ruff format --check .

[testenv:type]
description = Run type checking (mypy)
deps =
    mypy>=1.9.0
    types-PyYAML
commands =
    mypy telegram_bot_stack --config-file=pyproject.toml

[testenv:all]
description = Run all checks (lint, format, type, tests)
deps =
    pytest>=8.1.1
    pytest-cov>=5.0.0
    pytest-asyncio>=0.23.6
    pytest-mock>=3.14.0
    pytest-xdist>=3.5.0
    testcontainers>=3.7.0
    sqlalchemy>=2.0,<3.0
    psycopg2-binary>=2.9
    ruff>=0.6.0
    mypy>=1.9.0
    types-PyYAML
commands =
    ruff check .
    ruff format --check .
    mypy telegram_bot_stack --config-file=pyproject.toml
    pytest --cov=telegram_bot_stack --cov-report=term --no-cov-on-fail

[testenv:dev]
description = Development environment (install package in editable mode)
usedevelop = True
deps =
    pytest>=8.1.1
    pytest-cov>=5.0.0
    pytest-asyncio>=0.23.6
    pytest-mock>=3.14.0
    ruff>=0.6.0
    mypy>=1.9.0
    types-PyYAML
commands = python -c "print('Development environment ready')"
